# RyanMQ v2 - 持久化消息队列

这是RyanMQ的持久化版本，实现了高性能的消息存储与处理系统。

## 设计特性

- **分段文件存储**：使用segment文件将消息分段存储，便于管理和清理过期数据
- **内存映射(mmap)**：通过内存映射技术将磁盘文件映射到内存，减少磁盘IO
- **稀疏索引结构**：实现跳表式的索引，将消息偏移量(offset)映射到物理地址
- **多副本同步**：支持ISR（同步副本集）模式进行数据同步
- **顺序写入**：通过顺序写入避免随机IO，提高性能
- **零拷贝传输**：使用sendfile系统调用，实现直接内存到网卡的数据传输，避免用户态和内核态的多次拷贝
- **批量处理**：支持批量生产和消费消息，提高传输效率

## 主要组件

### 1. 存储层 (Storage)

- **Segment**：日志分段文件，使用内存映射技术减少IO操作
- **Index**：消息索引，实现快速定位消息位置
- **Log**：管理多个日志段，处理日志段的创建、切换和清理

### 2. 核心层 (Core)

- **Message**：消息结构体，包含消息数据和元数据
- **Topic**：主题，管理消息的发布和订阅
- **Broker**：消息代理，管理多个主题
- **Consumer/ConsumerGroup**：消费者和消费者组，管理订阅和消费消息

### 3. 生产者 (Producer)

- 支持单条和批量发送消息
- 自动批处理和定时刷新
- 消息确认机制

### 4. 工具 (Utils)

- **ZeroCopy**：零拷贝工具，优化数据传输效率

## 性能优化

1. **顺序写入**：通过顺序追加写入，利用操作系统的页缓存，极大提高写入速度
2. **批量传输**：将多条消息合并成一批进行处理，减少系统调用次数
3. **零拷贝**：使用sendfile系统调用，避免数据多次拷贝
4. **内存映射**：使用mmap将文件映射到内存，减少系统调用和数据拷贝
5. **分段存储**：便于并行处理和清理过期数据

## 使用示例

查看`main.go`文件可了解完整示例：
- 创建Broker、Topic、Producer和Consumer
- 生产和消费消息
- 并发处理与优雅关闭

## 未来扩展

- 集群功能：支持多节点部署和负载均衡
- 复制功能：实现跨节点的数据复制和同步
- 更多存储策略：支持LZ4/ZSTD压缩、加密等
- 监控和管理API：提供监控、统计和管理接口
